name: Build and Release

on:
    push:
        tags:
            - 'v*'
permissions:
    contents: write

jobs:
    build:
        name: Build (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest, windows-latest ]

        steps:
            -   name: Checkout
                uses: actions/checkout@v6

            -   name: Setup pnpm 10
                uses: pnpm/action-setup@v4
                with:
                    version: 10

            -   name: Setup Node.js 24
                uses: actions/setup-node@v6
                with:
                    node-version: 24
                    cache: pnpm
                    cache-dependency-path: pnpm-lock.yaml

            -   name: Install Modules
                run: pnpm install --frozen-lockfile

            -   name: Build
                run: pnpm run build

            -   name: Upload artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: dist-${{ matrix.os }}
                    path: dist/
                    retention-days: 1

    release:
        name: Release
        needs: build
        runs-on: ubuntu-latest

        steps:
            -   name: Download all artifacts
                uses: actions/download-artifact@v8
                with:
                    path: artifacts/

            -   name: List artifacts
                run: ls -R artifacts/

            -   name: Create Release
                uses: softprops/action-gh-release@v2
                with:
                    tag_name: ${{ github.ref_name }}
                    name: Release ${{ github.ref_name }}
                    draft: false
                    prerelease: ${{ contains(github.ref_name, '-') }}
                    generate_release_notes: true
                    files: |
                        artifacts/**/*